CREATE MATERIALIZED VIEW user_voting_status AS
SELECT DISTINCT
	u."fName",
	u."lName",
	u."username",
	u."userID",
	c."companyID",
	b."ballotID",
	CASE
		WHEN v."voteID" IS NOT NULL THEN TRUE
		ELSE FALSE
	END AS voted
FROM
	"user" u
	JOIN "company" c ON c."companyID" = u."companyID"
	JOIN "ballots" b ON b."companyID" = c."companyID"
	LEFT JOIN "votes" v ON v."userID" = u."userID"
	AND v."ballotID" = b."ballotID";

CREATE OR REPLACE FUNCTION check_ballot_voter(p_ballot_id INT, p_user_id INT)
RETURNS BOOLEAN AS $$
DECLARE
    vote_exists BOOLEAN;
BEGIN
    SELECT EXISTS (
        SELECT 1
        FROM votes
        WHERE ballotid = p_ballot_id
          AND userid = p_user_id
    ) INTO vote_exists;

    RETURN vote_exists;
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Unknown error during ballot voter check: %', SQLERRM;
END;
$$ LANGUAGE plpgsql;